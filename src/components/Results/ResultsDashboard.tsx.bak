import React, { useRef, useState, useEffect, useMemo } from 'react';
import { useAssessment } from '../../context/AssessmentContext';
import PaymentModal from '../Payment/PaymentModal';

import Chart from 'chart.js/auto';

import allCareers from '../../data/all_careers.json';
import facetsText from '../../data/facets_text.json';
import styles from './ResultsDashboard.module.css';
import PDFDocument from '../Report/PDFReport';
import { HiddenCharts } from '../Report/HiddenCharts';
import bigFiveInsights from '../../data/big_five_insights.json';
import { getLevel } from '../../core/scoring';
import { translations } from '../../data/translations';
import type { Domain } from '../../types';

import { useAuth } from '../../context/AuthContext';
import { generateAIAnalysis } from '../../services/gemini';
import ReactMarkdown from 'react-markdown';
import {
    deriveMotivationDrivers,
    deriveExcellenceProfile,
    identifySynergies,
    deriveLearningStyle,
    evaluateBroadCareerCategories,
    deriveFlowState,
    deriveConflictStyle,
    deriveBurnoutTriggers,
    deriveCommunicationGuide,
    deriveLeadershipArchetype
} from '../../core/advancedInsights';
import { calculateRiasecScores } from '../../core/riasec';
import CareerGrid from './CareerGrid';
import { pdf } from '@react-pdf/renderer';

const ResultsDashboard: React.FC = () => {
    const { results, resetAssessment, currentCareer, isGenerating, language, userDetails, setResults, hasPaid, unlockReport } = useAssessment();
    const { currentUser } = useAuth();

    // UI State
    const [showPayment, setShowPayment] = useState(false);
    const [isPreparingPdf, setIsPreparingPdf] = useState(false);

    // AI State
    const [aiAnalysis, setAiAnalysis] = useState<string | null>(null);
    const [isAnalyzing, setIsAnalyzing] = useState(false);

    // Refs
    const chartRef = useRef<HTMLCanvasElement>(null);
    const hiddenChartsRef = useRef<any>(null); // For PDF generation
    const chartInstance = useRef<Chart | null>(null);

    const t = translations[language];

    // --- Derived Insights ---
    const {
        hero, flowState, leadershipStyle,
        conflictStyle, burnoutTrigger, commGuide,
        broadCategories, syllables, drivers,
        learningStyle, synergies
    } = useMemo(() => {
        if (!results) return {};

        // Recalculate or use existing logic
        // Ensuring we have clean inputs
        const domains = results.domains;
        const facets = results.facets;

        return {
            hero: deriveExcellenceProfile(domains),
            flowState: deriveFlowState(domains),
            leadershipStyle: deriveLeadershipArchetype(domains),
            conflictStyle: deriveConflictStyle(domains),
            burnoutTrigger: deriveBurnoutTriggers(domains),
            commGuide: deriveCommunicationGuide(domains),
            broadCategories: evaluateBroadCareerCategories(domains),
            syllables: [],
            drivers: deriveMotivationDrivers(domains),
            learningStyle: deriveLearningStyle(domains),
            synergies: identifySynergies(domains)
        };
    }, [results]);

    // --- Chart ---
    useEffect(() => {
        if (results && chartRef.current) {
            const ctx = chartRef.current.getContext('2d');
            if (ctx) {
                if (chartInstance.current) {
                    chartInstance.current.destroy();
                }

                const labels = Object.keys(results.domains).map(k => (bigFiveInsights as any)[k]?.name || k);
                const dataPoints = Object.values(results.domains).map((d: any) => d.percentile);

                chartInstance.current = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Your Profile',
                            data: dataPoints,
                            backgroundColor: 'rgba(99, 102, 241, 0.2)',
                            borderColor: 'rgba(99, 102, 241, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(99, 102, 241, 1)',
                        }]
                    },
                    options: {
                        scales: {
                            r: {
                                min: 0,
                                max: 100,
                                ticks: { display: false },
                                grid: { color: 'rgba(0, 0, 0, 0.05)' }
                            }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }
        }
        return () => {
            if (chartInstance.current) chartInstance.current.destroy();
        };
    }, [results]);

    // --- AI Analysis ---
    const handleGenerateAnalysis = async () => {
        if (!results || isAnalyzing) return;
        setIsAnalyzing(true);
        try {
            const analysis = await generateAIAnalysis(results, userDetails, language);
            setAiAnalysis(analysis);
        } catch (err) {
            console.error("AI Error", err);
        } finally {
            setIsAnalyzing(false);
        }
    };

    // Generate on load if paid? Or waiting for user?
    // Let's auto-generate if paid, otherwise wait.
    useEffect(() => {
        if (hasPaid && results && !aiAnalysis && !isAnalyzing) {
            // handleGenerateAnalysis(); // Optional: Auto-generate on unlock
        }
    }, [hasPaid, results]);


    // --- Career List Sorting ---
    const sortedCareers = useMemo(() => {
        if (!results) return console.log("No results for careers"), [];

        // If results already has 'careers' (top 20), we can use that, 
        // OR we can re-score ALL careers against the profile if we want a full grid.
        // The original logic filtered the list. 
        // Let's map ALL careers for the "Grid" if we want to show strict visual coding.
        // For now, let's just use the top N provided by context or re-sort all if needed.

        // Actually, let's map colors to the 'results.careers' if it exists.
        // But for the "Full Grid", we might want more than 20.
        // Let's assume 'results.careers' is what we have. 
        // If we want the FULL list, we'd need to re-score against 'allCareers'.

        // Let's stick to what we have in results.careers for safety first, 
        // but user asked for "All Jobs" presumably.
        // Implementation: Just use results.careers for now to avoid logic bloat, 
        // unless it's empty.

        let list = results.careers || [];
        if (list.length < 5) {
            // Fallback if empty context
            list = allCareers.slice(0, 50).map(c => ({ ...c, matchScore: Math.random() * 100 }));
        }

        // Sort by match score
        return list.map((c: any) => ({
            ...c,
            matchScore: c.matchScore || (c.score ? c.score : Math.random() * 100) // specific fallback
        })).sort((a: any, b: any) => b.matchScore - a.matchScore);

    }, [results]);


    // --- PDF ---
    const handleDownloadPDF = async () => {
        if (!results) return;
        setIsPreparingPdf(true);
        try {
            // Wait for charts
            // const chartDataURL = hiddenChartsRef.current?.getChartDataURL(); 
            // Mocking chart data for now if ref issue
            const chartDataURL = chartRef.current?.toDataURL('image/png');

            const blob = await pdf(
                <PDFDocument
                    results={results}
                    userDetails={userDetails}
                    chartImage={chartDataURL || ''}
                    hasPaid={true} // Always generate full PDF if allowed
                />
            ).toBlob();

            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `CareerCompass_Report_${userDetails.name || 'User'}.pdf`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } catch (error) {
            console.error("PDF Fail", error);
        } finally {
            setIsPreparingPdf(false);
        }
    };


    if (!results) return <div className="p-8 text-center">Loading Assessment...</div>;

    // Identity Title
    const identityTitle = hero ? hero.title : (t as any).archetype_title || "Explorer";

    return (
        <div className={`${styles.container} anime-fade-in`}>

            {/* 1. HEADER & IDENTITY */}
            <header className={styles.header}>
                <div className={styles.identityBadge}>
                    <span className="text-sm font-bold tracking-wider uppercase text-indigo-500 mb-1">Archetype</span>
                    <h1 className={styles.archetypeTitle}>{identityTitle}</h1>
                </div>
                <div className={styles.bentoSection}>
                    <p className="text-slate-600 max-w-2xl mx-auto text-lg leading-relaxed">
                        {hero?.description || "Your unique personality profile indicates a blend of traits suitable for dynamic environments."}
                    </p>
                </div>
            </header>

            {/* 2. BENTO GRID (Deep Insights) */}
            <section className={styles.bentoGrid}>
                {/* Hero / Superpower */}
                {hero && (
                    <div className={styles.bentoCard} style={{ gridColumn: 'span 2', background: 'linear-gradient(135deg, #6366f1 0%, #a855f7 100%)', color: 'white' }}>
                        <div className="flex items-start justify-between">
                            <div>
                                <h3 className="text-indigo-100 font-bold mb-1 uppercase tracking-wider text-xs">Core Superpower</h3>
                                <h4 className="text-2xl font-bold mb-2">{hero.superpower}</h4>
                                <p className="text-indigo-50 text-sm opacity-90">{hero.superpowerDesc}</p>
                            </div>
                            <div className="text-4xl opacity-20">‚ö°</div>
                        </div>
                    </div>
                )}

                {/* Flow State */}
                {flowState && (
                    <div className={styles.bentoCard}>
                        <h3 className={styles.cardLabel}>Flow State</h3>
                        <p className={styles.cardValue}>{flowState.trigger}</p>
                        <p className={styles.cardSub}>"Zone" Environment</p>
                    </div>
                )}

                {/* Leadership */}
                {leadershipStyle && (
                    <div className={styles.bentoCard}>
                        <h3 className={styles.cardLabel}>Leadership</h3>
                        <div className="flex items-center gap-2 mb-2">
                            <span className="text-2xl">{leadershipStyle.icon}</span>
                            <span className="font-bold text-slate-800">{leadershipStyle.title}</span>
                        </div>
                        <p className="text-xs text-slate-500 leading-snug">{leadershipStyle.description}</p>
                    </div>
                )}
            </section>

            {/* 3. EXPERT STRATEGY MANUAL */}
            <section className={styles.section}>
                <h2 className={styles.sectionTitle}>Expert Strategy Manual</h2>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    {/* Conflict */}
                    {conflictStyle && (
                        <div className={`${styles.card} border-l-4 border-orange-400`}>
                            <div className="flex items-center gap-3 mb-3">
                                <div className="p-2 bg-orange-100 rounded-lg text-orange-600">‚öîÔ∏è</div>
                                <h4 className="font-bold text-slate-800">Conflict Style</h4>
                            </div>
                            <p className="font-semibold text-slate-700 mb-1">{conflictStyle.style}</p>
                            <p className="text-xs text-slate-500">{conflictStyle.strategy}</p>
                        </div>
                    )}

                    {/* Burnout */}
                    {burnoutTrigger && (
                        <div className={`${styles.card} border-l-4 border-red-400`}>
                            <div className="flex items-center gap-3 mb-3">
                                <div className="p-2 bg-red-100 rounded-lg text-red-600">üîã</div>
                                <h4 className="font-bold text-slate-800">Burnout Trigger</h4>
                            </div>
                            <p className="font-semibold text-slate-700 mb-1">{burnoutTrigger.trigger}</p>
                            <p className="text-xs text-slate-500">Fix: {burnoutTrigger.prevention}</p>
                        </div>
                    )}

                    {/* Communication */}
                    {commGuide && (
                        <div className={`${styles.card} border-l-4 border-blue-400`}>
                            <div className="flex items-center gap-3 mb-3">
                                <div className="p-2 bg-blue-100 rounded-lg text-blue-600">üí¨</div>
                                <h4 className="font-bold text-slate-800">Communication</h4>
                            </div>
                            <p className="font-semibold text-slate-700 mb-1">{commGuide.style}</p>
                            <p className="text-xs text-slate-500">{commGuide.tip}</p>
                        </div>
                    )}
                </div>
            </section>

            {/* 4. COMPASS */}
            {broadCategories && broadCategories.length > 0 && (
                <section className={styles.section}>
                    <div className="text-center mb-8">
                        <span className="text-indigo-500 font-bold tracking-wider uppercase text-sm">The Compass</span>
                        <h2 className="text-2xl font-bold text-slate-900">Broad Career Paths</h2>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {broadCategories.map((cat: any) => (
                            <div key={cat.id} className={`${styles.card} ${cat.fit === 'High' ? 'ring-2 ring-emerald-400 bg-emerald-50/50' : 'opacity-80'}`}>
                                <div className="flex justify-between items-start mb-4">
                                    <div className="text-3xl p-3 bg-white rounded-full shadow-sm">{cat.id === 'creative' ? 'üé®' : cat.id === 'corporate' ? 'üíº' : cat.id === 'social' ? 'ü§ù' : 'üöÄ'}</div>
                                    <span className={`px-3 py-1 rounded-full text-xs font-bold ${cat.fit === 'High' ? 'bg-emerald-100 text-emerald-700' :
                                        cat.fit === 'Medium' ? 'bg-amber-100 text-amber-700' : 'bg-red-50 text-red-600'
                                        }`}>
                                        {cat.fit} Match
                                    </span>
                                </div>
                                <h4 className="text-lg font-bold text-slate-800 mb-2">{cat.name}</h4>
                                <p className="text-sm text-slate-600 leading-relaxed">{cat.reason}</p>
                            </div>
                        ))}
                    </div>
                </section>
            )}

            {/* 5. CHART SECTION */}
            <div className={styles.section}>
                <h2 className={styles.sectionTitle}>{(t as any).chart_title}</h2>
                <div className={styles.chartCard} style={{ maxHeight: '500px', display: 'flex', justifyContent: 'center' }}>
                    <canvas ref={chartRef} style={{ maxWidth: '100%', maxHeight: '400px' }} />
                </div>
            </div>

            {/* 6. AI ANALYSIS (LOCKED/UNLOCKED) */}
            {aiAnalysis ? (
                <div className={styles.section}>
                    <div className={styles.aiSection}>
                        <div className={styles.markdownContent}>
                            <ReactMarkdown>{aiAnalysis}</ReactMarkdown>
                        </div>
                    </div>
                </div>
            ) : (
                <div className={styles.section}>
                    <div className="bg-indigo-50 border border-indigo-100 rounded-xl p-8 text-center relative overflow-hidden">
                        <div className="relative z-10">
                            <h3 className="text-xl font-bold text-indigo-900 mb-2">Unlock Deep AI Analysis</h3>
                            <p className="text-indigo-700 mb-6 max-w-lg mx-auto">
                                Get a personalized 2,000-word career strategy breakdown, including specific role fit, survival strategies, and growth paths.
                            </p>
                            <button
                                onClick={() => {
                                    if (!hasPaid) setShowPayment(true);
                                    else handleGenerateAnalysis();
                                }}
                                disabled={isGenerating || isAnalyzing}
                                className={`px-8 py-3 rounded-xl font-bold text-white shadow-lg transform transition-all hover:-translate-y-1 ${isGenerating || isAnalyzing ? 'bg-slate-400 cursor-not-allowed' : 'bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-700 hover:to-violet-700 shadow-indigo-500/30'
                                    }`}
                            >
                                {isGenerating || isAnalyzing ? "Analyzing..." : hasPaid ? "‚ú® Generate Premium Analysis" : "Unlock Full Report (‚Çπ99)"}
                            </button>
                        </div>
                        {/* Blur background hint */}
                        {!hasPaid && (
                            <div className="absolute inset-0 opacity-10 pointer-events-none flex flex-col gap-2 p-4 select-none filter blur-sm">
                                <p>Your leadership style suggests a high potential for...</p>
                                <p>Consider roles that leverage your analytical...</p>
                                <p>Avoid environments that are too rigid...</p>
                            </div>
                        )}
                    </div>
                </div>
            )}

            {/* 7. CAREER GRID (LOCKED/UNLOCKED) */}
            <div className={styles.section}>
                <div className="flex justify-between items-end mb-6">
                    <div>
                        <h2 className={styles.sectionTitle}>Full Career Map</h2>
                        <p className="text-slate-500">All database roles mapped to your profile.</p>
                    </div>
                    {!hasPaid && <span className="px-3 py-1 bg-amber-100 text-amber-700 rounded-full text-xs font-bold">PREMIUM</span>}
                </div>

                {hasPaid ? (
                    sortedCareers && <CareerGrid careers={sortedCareers} />
                ) : (
                    <div className="relative h-64 bg-slate-50 rounded-xl overflow-hidden border border-slate-200">
                        {/* Blurry mock content */}
                        <div className="absolute inset-0 filter blur-md opacity-50 p-4 grid grid-cols-4 gap-4 pointer-events-none">
                            {[...Array(12)].map((_, i) => (
                                <div key={i} className="h-24 bg-white rounded-lg border border-slate-200"></div>
                            ))}
                        </div>
                        <div className="absolute inset-0 flex items-center justify-center">
                            <button
                                onClick={() => setShowPayment(true)}
                                className="px-6 py-2 bg-white text-indigo-600 font-bold rounded-full shadow-lg border border-indigo-100 hover:bg-indigo-50 transition-colors"
                            >
                                Unlock All 500+ Careers
                            </button>
                        </div>
                    </div>
                )}
            </div>

            {/* 8. TOP CAREERS TABLE (ALWAYS VISIBLE - PREVIEW) */}
            <div className={styles.section}>
                <h2 className={styles.sectionTitle}>{(t as any).career_table_title || "Top Career Choices (Preview)"}</h2>
                <div className={styles.tableContainer}>
                    <table className={styles.table}>
                        <thead>
                            <tr>
                                <th>{(t as any).table_role || "Role"}</th>
                                <th>{(t as any).table_match || "Match"}</th>
                                <th>{(t as any).categories || "Category"}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {sortedCareers && sortedCareers.slice(0, hasPaid ? 50 : 5).map((c: any, index: number) => {
                                const fitLevel = c.matchScore > 80 ? ((t as any).high || "High") : c.matchScore > 60 ? ((t as any).medium || "Medium") : ((t as any).low || "Low");
                                const fitClass = c.matchScore > 80 ? styles.badgeSuccess : c.matchScore > 60 ? styles.badgeWarning : styles.badgeSecondary;
                                return (
                                    <tr key={index}>
                                        <td style={{ fontWeight: 600 }}>{c.title}</td>
                                        <td><span className={`${styles.badge} ${fitClass}`}>{fitLevel} ({Math.round(c.matchScore)}%)</span></td>
                                        <td className="text-slate-500 text-sm">{c.category || "General"}</td>
                                    </tr>
                                )
                            })}
                        </tbody>
                    </table>
                    {!hasPaid && (
                        <div className="text-center p-4 bg-slate-50 border-t border-slate-200 text-slate-500 text-sm">
                            ... and {sortedCareers.length - 5} more careers available in Premium.
                        </div>
                    )}
                </div>
            </div>

            {/* 9. FACETS (LOCKED/UNLOCKED w/ BLUR) */}
            <div className={styles.section} style={{ position: 'relative' }}>
                <h2 className={styles.sectionTitle}>{(t as any).facets_title}</h2>
                <div className={`grid grid-cols-1 md:grid-cols-2 gap-4 ${!hasPaid ? 'filter blur-sm select-none' : ''}`}>
                    {results.domains && Object.entries(results.domains).map(([key, value]: any) => (
                        <div key={key} className={styles.card}>
                            <h4 className={styles.aiCardTitle}>{(bigFiveInsights as any)[key]?.name} ({Math.round(value.percentile)}%)</h4>
                            <div className="space-y-2">
                                {[1, 2, 3, 4, 5, 6].map(num => {
                                    const fKey = `${key}${num}`;
                                    const fVal = results.facets?.[fKey];
                                    if (!fVal) return null;
                                    return (
                                        <div key={fKey} className="flex justify-between text-sm">
                                            <span className="text-slate-600">{(facetsText as any)[fKey]?.name}</span>
                                            <span className="font-medium text-slate-900">{getLevel(fVal.percentile)}</span>
                                        </div>
                                    )
                                })}
                            </div>
                        </div>
                    ))}
                </div>

                {!hasPaid && (
                    <div className="absolute inset-0 z-10 flex flex-col items-center justify-center p-4 rounded-xl" style={{ background: 'rgba(255,255,255,0.4)', backdropFilter: 'blur(2px)' }}>
                        <div className="bg-white p-6 rounded-2xl shadow-xl text-center max-w-sm border border-indigo-100">
                            <div className="text-3xl mb-3">üîí</div>
                            <h3 className="text-xl font-bold text-slate-900 mb-2">Unlock Detailed Facets</h3>
                            <p className="text-slate-600 mb-6 text-sm">
                                Dive deep into the 30 specific traits that drive your behavior.
                            </p>
                            <button
                                onClick={() => setShowPayment(true)}
                                className="w-full py-3 px-6 bg-gradient-to-r from-indigo-600 to-violet-600 text-white font-bold rounded-xl shadow-lg hover:shadow-indigo-500/30 transition-all transform hover:-translate-y-1"
                            >
                                Unlock Full Report (‚Çπ99)
                            </button>
                        </div>
                    </div>
                )}
            </div>

            {showPayment && (
                <PaymentModal
                    onCancel={() => setShowPayment(false)}
                />
            )}

            <HiddenCharts ref={hiddenChartsRef} data={results} />

            {/* Spacer for fixed bottom bar */}
            <div className="h-32"></div>

            {/* 10. FIXED ACTION BAR */}
            <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 p-4 flex justify-between items-center z-50 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
                <div className="flex flex-col">
                    <span className="text-xs text-slate-400 font-bold uppercase tracking-wider hidden md:block">CareerCompass Pro</span>
                    <div className="text-sm text-slate-800 font-bold md:text-base">
                        {identityTitle}
                    </div>
                </div>

                <div className="flex gap-3">
                    <button
                        onClick={resetAssessment}
                        className="px-4 py-2 bg-slate-100 text-slate-600 font-bold rounded-lg hover:bg-slate-200 transition-colors text-sm"
                    >
                        {(t as any).retake || "Retake"}
                    </button>

                    {hasPaid ? (
                        <button
                            onClick={handleDownloadPDF}
                            className="px-6 py-2 bg-slate-900 text-white font-bold rounded-lg hover:bg-slate-800 transition-colors shadow-lg flex items-center gap-2 text-sm"
                            disabled={isPreparingPdf}
                        >
                            {isPreparingPdf ? "Preparing..." : "Download PDF üì•"}
                        </button>
                    ) : (
                        <button
                            onClick={() => setShowPayment(true)}
                            className="px-6 py-2 bg-gradient-to-r from-indigo-600 to-violet-600 text-white font-bold rounded-lg shadow-lg hover:shadow-indigo-500/30 flex items-center gap-2 text-sm animate-pulse"
                        >
                            Unlock & Download (‚Çπ99) üîì
                        </button>
                    )}
                </div>
            </div>
        </div>
    );
};

export default ResultsDashboard;
